var cash_receipt ={};

var CashReceipt = function() {

    var obj = {};
    var self = this;

    self.obj = obj;
    self.initialize = initialize;
    self.initialize_associations = initialize_associations;
    self.compute_amounts = compute_amounts;

    $(".cash_receipt").blur(function() {
        initialize(this);
    });

    function initialize(input) {
        if (isEmpty(obj)) {
            var model_name = get_model_name(input);
            var r = get_invoice_attrs(model_name);
            var subtotal = $("#" + model_name + "_subtotal");
            var additional_discount = $("#" + model_name + "_additional_discount");
            var withholding_vat = $("#" + model_name + "_withholding_vat");
            var total_paid = $("#" + model_name + "_total_paid");

            obj.issue_date =  $("#" + model_name + "_issue_date");
            obj.gross_value = r.gross_value;
            obj.discount = r.discount;
            obj.vat = r.vat;
            obj.freight = r.freight;
            obj.subtotal = subtotal;
            obj.additional_discount = additional_discount;
            obj.withholding_vat = withholding_vat;
            obj.withholding_source = r.withholding_source;
            obj.refund_value = r.refund_value;
            obj.paid_value = r.paid_value;
            obj.total = r.total;
            obj.balance = r.balance;
            obj.total_paid = total_paid;

            if(obj.issue_date.val() == "") {
                obj.issue_date.val(current_date());
            }
        }
        compute_amounts();
    }

    function initialize_associations() {
        var customer_input = $('.receipt_customer:first').get(0);
        if (typeof customer_input !== 'undefined') {
            customer = new Customer();
            customer.initialize(customer_input);
        }
        receipt_detail = new ReceiptDetail();
        receipt_detail.find_line_items();
        payment_method = new PaymentMethod();
        payment_method.find_line_items();
    }

    function compute_amounts() {
        if (!isEmpty(obj) && !isEmpty(receipt_detail)) {
            var rd = receipt_detail.compute_amounts();

            obj.gross_value.val( rd.gross_value );
            obj.discount.val( rd.discount );
            obj.freight.val( rd.freight );
            obj.vat.val( rd.vat );
            obj.subtotal.val( rd.subtotal );
            obj.refund_value.val( rd.refund_value );
            obj.paid_value.val( rd.paid_value );

            var deductions = 1 * obj.additional_discount.asNumber() + 1 * obj.withholding_source.asNumber() + 1 * obj.withholding_vat.asNumber();
            var grand_total = rd.balance - deductions;
            $(".amount_received").val((rd.amount_paid - deductions)).formatCurrency();
            obj.total.val(grand_total);
            format_fields();
        }
    }

    function format_fields() {
        obj.gross_value.formatCurrency();
        obj.discount.formatCurrency();
        obj.freight.formatCurrency();
        obj.vat.formatCurrency();
        obj.subtotal.formatCurrency();
        obj.additional_discount.formatCurrency();
        obj.withholding_vat.formatCurrency();
        obj.withholding_source.formatCurrency();
        obj.refund_value.formatCurrency();
        obj.paid_value.formatCurrency();
        obj.total.formatCurrency();
    }

}
